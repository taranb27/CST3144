<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/vue@2.7.8/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>

    <title>Document</title>
</head>
<body>
    <div id="app">
        <h1 style="font-size: 28px; text-align: center; padding: 2%;">{{title1}}</h1>
        <!-- Checkout Button -->
        <button v-on:click="showCart" class="btn btn-info" style="margin-left: 10px; margin-bottom: 20px;">
            {{countItemInCart}}
            <span class="fa fa-cart-plus"></span>
            Cart
        </button>

        <div>
            <!-- Dropdown to select attribute to sort by -->
            <label for="sort-attribute">Sort by:</label>
            <select v-model="sortAttribute" id="sort-attribute">
                <option value="Subject">Subject</option>
                <option value="Location">Location</option>
                <option value="Price">Price</option>
                <option value="Spaces">Spaces</option>
            </select>
        
            <!-- Dropdown to select ascending or descending order -->
            <label for="sort-order">Order:</label>
            <select v-model="sortOrder" id="sort-order">
                <option value="asc">Ascending</option>
                <option value="desc">Descending</option>
            </select>
        </div>

        <div style="display: flex; flex-direction: column; justify-content: center; align-items: center;">
            <main>
                <div v-if="showSubject">

                    <div style="display: flex; flex-wrap: wrap;">
                        <div v-for="subject in sortedCourses" class="card" style="width: 250px; margin: 10px;">
                            <p class="card-text" style="padding: 0; margin: 0; margin-left: 10px; margin-top: 10px;;">Subject: {{subject.Subject}}</p>
                            <p class="card-text" style="padding: 0; margin: 0; margin-left: 10px;">Location: {{subject.Location}}</p>
                            <p class="card-text" style="padding: 0; margin: 0; margin-left: 10px;">Price: {{subject.Price}}</p>
                            <p class="card-text" style="margin-left: 10px;">Spaces: {{subject.Spaces}}</p>

                            <!-- Add to Cart Button -->
                            <button class="btn btn-primary" style="margin-bottom: 10px; margin-left: 10px; margin-right: 10px;" v-on:click="addItemToCart(subject)" v-if="CanAddItemToCart(subject)">Add to Cart</button>
                            <div v-else>
                                <button class="btn btn-secondary" disabled>Add to Cart</button>
                                <span v-if="subject.Spaces === CartCount(subject._id)">Housefull!</span>
                                <span v-else>Buy Now!</span>
                            </div>
                        </div>
                    </div>

                </div>

                <div v-else>
                    <h1 style="font-size: 28px; text-align: center; padding: 2%;">{{title2}}</h1>

                    <div style="display: flex; flex-wrap: wrap; flex-direction: column; justify-content: center; align-items: center;">
                        <div v-for="(subj, i) in cart" class="card" style="width: 250px; margin: 10px">
                            <p class="card-text" style="padding: 0; margin: 0; margin-left: 10px; margin-top: 10px;;">Subject: {{subj.subject}}</p>
                            <p class="card-text" style="padding: 0; margin: 0; margin-left: 10px;">Location: {{subj.location}}</p>
                            <p class="card-text" style="padding: 0; margin: 0; margin-left: 10px;">Price: {{subj.price}}</p>
                            <button v-on:click="removeItemFromCart(i, subj.id)" type="button" class="btn btn-danger" style="margin-bottom: 10px; margin-left: 10px; margin-right: 10px;" >Remove</button>
                        </div>

                        <div>        
                            <div style="display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                <form style="width: 500px;">
                                    <p><input v-model.trim="checkout.firstName" class="form-control" placeholder="First Name"></p>
                                    <p><input v-model.trim="checkout.lastName" class="form-control" placeholder="Last Name"></p>
                                    <p><input v-model.trim="checkout.number" class="form-control" placeholder="Phone Number"></p>
                                    <button v-on:click="submitForm" type="button" class="btn btn-success">Checkout</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>



            </main>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

    <script>
        let webstore = new Vue({
            el: '#app',
            data: {
                title1: "After School Classes",
                title2: "Welcome to the Checkout page",
                showSubject: true,
                courses: [],
                cart: [],
                checkout: {
                    firstName: '',
                    lastName: '',
                    number: ''
                },
                sortAttribute: 'Subject',
                sortOrder: 'asc'
            },
            methods: {
                fetchCourses() {
                    fetch('http://localhost:8080/courses')  
                        .then(response => response.json())
                        .then(data => {
                            this.courses = data;
                        })
                        .catch(error => {
                            console.error('error fetching courses:', error)
                        })
                },
                
                addItemToCart(course) {
                    if (course.Spaces > 0) {
                        this.cart.push({
                            id: course._id,
                            subject: course.Subject,
                            location: course.Location,
                            price: course.Price
                        })
                        course.Spaces--
                    }
                },

                removeItemFromCart(i, courseid) {
                    const course = this.courses.find(item => item._id === courseid)
                    if(course) {
                        course.Spaces++
                    }
                    this.cart.splice(i,1)
                },

                CanAddItemToCart(course) {
                    return course.Spaces > 0;
                },

                CartCount(id) {
                    return this.cart.filter(item => item === id).length; 
                },

                showCart() {
                    this.showSubject = !this.showSubject;
                },

                submitForm() {
                    if (
                        this.checkout.firstName &&
                        this.checkout.lastName &&
                        this.checkout.number
                    ){
                        Swal.fire({
                            title: "Success",
                            text: "Checkout Completed",
                            icon: "success"
                        });
                    } else if (
                        this.cart.length === 0
                    ){
                        Swal.fire({
                            title: "Error",
                            text: "Cart is empty, please select a course",
                            icon: "error"
                        });
                    } else {
                        Swal.fire({
                            title: "Error",
                            text: "Checkout form incomplete",
                            icon: "error"
                        });
                    }
                }
            },
            created() {
                this.fetchCourses();  
            },
            computed: {
                countItemInCart() {
                    return this.cart.length || "";
                },

                itemsLeft() {
                    return this.subject.Spaces - this.countItemInCart
                },

                sortedCourses() {
                    return _.orderBy(
                        this.courses,
                        [this.sortAttribute],
                        [this.sortOrder]
                    )
                }
            }
        });

    </script>
</body>
</html>